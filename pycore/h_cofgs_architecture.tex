\documentclass[border=8pt, multi, tikz]{standalone}

\usetikzlibrary{quotes,arrows.meta}
\usetikzlibrary{positioning}
\usetikzlibrary{3d}
\usetikzlibrary{calc}

\def\edgecolor{rgb:blue,4;red,1;green,4;black,3}
\newcommand{\midarrow}{\tikz \draw[-Stealth,line width =0.8mm,draw=\edgecolor] (-0.3,0) -- ++(0.3,0);}

\ProvidesPackage{Ball}
\tikzset{Ball/.pic={\tikzset{/sphere/.cd,#1}	 

\pgfmathsetmacro{\r}{\radius*\scale}

\shade[ball color=\fill,opacity=\opacity] (0,0,0) circle (\r);
\draw (0,0,0) circle [radius=\r] node[scale=4*\r] {\logo};

\coordinate (\name-anchor) at ( 0 , 0  , 0) ;
\coordinate (\name-east)   at ( \r, 0  , 0) ;
\coordinate (\name-west)   at (-\r, 0  , 0) ;
\coordinate (\name-north)  at ( 0 , \r , 0) ;
\coordinate (\name-south)  at ( 0 , -\r, 0) ;

\path (\name-south) + (0,-20pt) coordinate (caption-node) 
edge ["\textcolor{black}{\bf \caption}"'] (caption-node);

},
/sphere/.search also={/tikz},
/sphere/.cd,
radius/.store       in=\radius,
scale/.store        in=\scale,
caption/.store      in=\caption,
name/.store         in=\name,
fill/.store         in=\fill,
logo/.store         in=\logo,
opacity/.store      in=\opacity,
logo=$\Sigma$,
fill=green,
opacity=0.10,
scale=0.2,
radius=0.5,
caption=,
name=,
}

\ProvidesPackage{Box}

\tikzset{Box/.pic={\tikzset{/boxblock/.cd,#1}
        \tikzstyle{box}=[every edge/.append style={pic actions, densely dashed, opacity=.7},fill opacity=\opacity, pic actions,fill=\fill]
        
        \pgfmathsetmacro{\y}{\cubey*\scale}
        \pgfmathsetmacro{\z}{\cubez*\scale}
   
        \foreach[count=\i,%
                 evaluate=\i as \xlabel using {array({\boxlabels},\i-1)},% 
                 evaluate=\unscaledx as \k using {\unscaledx*\scale+\prev}, remember=\k as \prev (initially 0)] 
                 \unscaledx in \cubex
        {
            \pgfmathsetmacro{\x}{\unscaledx*\scale}
            \coordinate (a) at (\k-\x , \y/2 , \z/2); 
            \coordinate (b) at (\k-\x ,-\y/2 , \z/2); 
            \coordinate (c) at (\k    ,-\y/2 , \z/2); 
            \coordinate (d) at (\k    , \y/2 , \z/2); 
            \coordinate (e) at (\k    , \y/2 ,-\z/2); 
            \coordinate (f) at (\k    ,-\y/2 ,-\z/2); 
            \coordinate (g) at (\k-\x ,-\y/2 ,-\z/2); 
            \coordinate (h) at (\k-\x , \y/2 ,-\z/2); 
        
            \draw [box] 
                (d) -- (a) -- (b) -- (c) -- cycle     
                (d) -- (a) -- (h) -- (e) -- cycle
                (f) edge (g)
                (b) edge (g)
                (h) edge (g)    
            ;
            \path (b) edge ["\Large\xlabel"',midway,font=\Large] (c);
            
            \xdef\LastEastx{\k}
        }
        \draw [box] (d) -- (e) -- (f) -- (c) -- cycle;
        
        \coordinate (a1) at (0 , \y/2 , \z/2);
        \coordinate (b1) at (0 ,-\y/2 , \z/2);
        \tikzstyle{depthlabel}=[pos=0,text width=14*\z,text centered,sloped]       
        
        \path (c) edge ["\Large\zlabel"',depthlabel](f);
        \path (b1) edge ["\Large\ylabel",midway] (a1);
        
        \tikzstyle{captionlabel}=[text width=15*\LastEastx/\scale,text centered,font=\Large]       
        \path (\LastEastx/2,-\y/2,+\z/2) + (0,-25pt) coordinate (cap) 
        edge ["\textcolor{black}{ \bf \caption}"',captionlabel](cap);
         
        \coordinate (\name-west)   at (0,0,0) ;
        \coordinate (\name-east)   at (\LastEastx, 0,0) ;
        \coordinate (\name-north)  at (\LastEastx/2,\y/2,0);
        \coordinate (\name-south)  at (\LastEastx/2,-\y/2,0);       
        \coordinate (\name-anchor) at (\LastEastx/2, 0,0) ;
        
        \coordinate (\name-near) at (\LastEastx/2,0,\z/2);
        \coordinate (\name-far)  at (\LastEastx/2,0,-\z/2);       
        
        \coordinate (\name-nearwest) at (0,0,\z/2);
        \coordinate (\name-neareast) at (\LastEastx,0,\z/2);
        \coordinate (\name-farwest)  at (0,0,-\z/2);
        \coordinate (\name-fareast)  at (\LastEastx,0,-\z/2);
        
        \coordinate (\name-northeast) at (\name-north-|\name-east);
        \coordinate (\name-northwest) at (\name-north-|\name-west);
        \coordinate (\name-southeast) at (\name-south-|\name-east);
        \coordinate (\name-southwest) at (\name-south-|\name-west);
        
        \coordinate (\name-nearnortheast)  at (\LastEastx, \y/2, \z/2);
        \coordinate (\name-farnortheast)   at (\LastEastx, \y/2,-\z/2);
        \coordinate (\name-nearsoutheast)  at (\LastEastx,-\y/2, \z/2);
        \coordinate (\name-farsoutheast)   at (\LastEastx,-\y/2,-\z/2);
        
        \coordinate (\name-nearnorthwest)  at (0, \y/2, \z/2);
        \coordinate (\name-farnorthwest)   at (0, \y/2,-\z/2);
        \coordinate (\name-nearsouthwest)  at (0,-\y/2, \z/2);
        \coordinate (\name-farsouthwest)   at (0,-\y/2,-\z/2);
    },
    /boxblock/.search also={/tikz},
    /boxblock/.cd,
    width/.store        in=\cubex,
    height/.store       in=\cubey,
    depth/.store        in=\cubez,
    scale/.store        in=\scale,
    xlabel/.store       in=\boxlabels,
    ylabel/.store       in=\ylabel,
    zlabel/.store       in=\zlabel,
    caption/.store      in=\caption,
    name/.store         in=\name,
    fill/.store         in=\fill,
    opacity/.store      in=\opacity,
    fill={rgb:red,5;green,5;blue,5;white,15},
    opacity=0.4,
    width=2,
    height=13,
    depth=15,
    scale=.2,
    xlabel={{"","","","","","","","","",""}},
    ylabel=,
    zlabel=,
    caption=,
    name=,
}

\ProvidesPackage{RightBandedBox}

\tikzset{RightBandedBox/.pic={\tikzset{/block/.cd,#1}
                
        \tikzstyle{box}=[every edge/.append style={pic actions, densely dashed, opacity=.7},fill opacity=\opacity, pic actions,fill=\fill]
        
        \tikzstyle{band}=[every edge/.append style={pic actions, densely dashed, opacity=.7},fill opacity=\bandopacity, pic actions,fill=\bandfill,draw=\bandfill]
        
        \pgfmathsetmacro{\y}{\cubey*\scale}
        \pgfmathsetmacro{\z}{\cubez*\scale}

        \foreach[count=\i,%
                 evaluate=\i as \xlabel using {array({\boxlabels},\i-1)},% 
                 evaluate=\unscaledx as \k using {\unscaledx*\scale+\prev}, remember=\k as \prev (initially 0)] 
                 \unscaledx in \cubex
        {
            \pgfmathsetmacro{\x}{\unscaledx*\scale}
            \coordinate (a)     at (\k-\x   , \y/2 , \z/2); 
            \coordinate (art)   at (\k-\x/3 , \y/2 , \z/2);
            \coordinate (b)     at (\k-\x   ,-\y/2 , \z/2); 
            \coordinate (brt)   at (\k-\x/3 ,-\y/2 , \z/2);
            \coordinate (c)     at (\k      ,-\y/2 , \z/2); 
            \coordinate (d)     at (\k      , \y/2 , \z/2); 
            \coordinate (e)     at (\k      , \y/2 ,-\z/2); 
            \coordinate (f)     at (\k      ,-\y/2 ,-\z/2); 
            \coordinate (g)     at (\k-\x   ,-\y/2 ,-\z/2); 
            \coordinate (h)     at (\k-\x   , \y/2 ,-\z/2); 
            \coordinate (hrt)   at (\k-\x/3 , \y/2 ,-\z/2);
            
            \draw [box] 
                (d) -- (a) -- (b) -- (c) -- cycle     
                (d) -- (a) -- (h) -- (e) -- cycle;
            \draw [box]
                (f) edge (g)
                (b) edge (g)
                (h) edge (g);
            \draw [band] 
                (d) -- (art) -- (brt) -- (c) -- cycle     
                (d) -- (art) -- (hrt) -- (e) -- cycle;
            \draw [box,fill opacity=0] 
                (d) -- (a) -- (b) -- (c) -- cycle     
                (d) -- (a) -- (h) -- (e) -- cycle;            
            	
            \path (b) edge ["\large\xlabel"',midway,font=\large] (c);
            
            \xdef\LastEastx{\k}
        }
        \draw [box] (d) -- (e) -- (f) -- (c) -- cycle;
        \draw [band] (d) -- (e) -- (f) -- (c) -- cycle;
        \draw [pic actions] (d) -- (e) -- (f) -- (c) -- cycle;
        
        \coordinate (a1) at (0 , \y/2 , \z/2);
        \coordinate (b1) at (0 ,-\y/2 , \z/2);
        \tikzstyle{depthlabel}=[pos=0,text width=14*\z,text centered,sloped,font=\normalfont]       
        
        \path (c) edge ["\large\zlabels"',depthlabel](f);
        \path (b1) edge ["\ylabel",midway] (a1);
        
        \tikzstyle{captionlabel}=[text width=15*\LastEastx/\scale,text centered,font=\large] 
        \path (\LastEastx/2,-\y/2,+\z/2) + (0,-25pt) coordinate (cap) 
        edge ["\textcolor{black}{ \bf \caption}"',captionlabel] (cap);
         
        \coordinate (\name-west)   at (0,0,0) ;
        \coordinate (\name-east)   at (\LastEastx, 0,0) ;
        \coordinate (\name-north)  at (\LastEastx/2,\y/2,0);
        \coordinate (\name-south)  at (\LastEastx/2,-\y/2,0);       
        \coordinate (\name-anchor) at (\LastEastx/2, 0,0) ;
        
        \coordinate (\name-near) at (\LastEastx/2,0,\z/2);
        \coordinate (\name-far)  at (\LastEastx/2,0,-\z/2);       
        
        \coordinate (\name-nearwest) at (0,0,\z/2);
        \coordinate (\name-neareast) at (\LastEastx,0,\z/2);
        \coordinate (\name-farwest)  at (0,0,-\z/2);
        \coordinate (\name-fareast)  at (\LastEastx,0,-\z/2);
        
        \coordinate (\name-northeast) at (\name-north-|\name-east);
        \coordinate (\name-northwest) at (\name-north-|\name-west);
        \coordinate (\name-southeast) at (\name-south-|\name-east);
        \coordinate (\name-southwest) at (\name-south-|\name-west);
        
        \coordinate (\name-nearnortheast)  at (\LastEastx, \y/2, \z/2);
        \coordinate (\name-farnortheast)   at (\LastEastx, \y/2,-\z/2);
        \coordinate (\name-nearsoutheast)  at (\LastEastx,-\y/2, \z/2);
        \coordinate (\name-farsoutheast)   at (\LastEastx,-\y/2,-\z/2);
        
        \coordinate (\name-nearnorthwest)  at (0, \y/2, \z/2);
        \coordinate (\name-farnorthwest)   at (0, \y/2,-\z/2);
        \coordinate (\name-nearsouthwest)  at (0,-\y/2, \z/2);
        \coordinate (\name-farsouthwest)   at (0,-\y/2,-\z/2);
    },
    /block/.search also={/tikz},
    /block/.cd,
    width/.store        in=\cubex,
    height/.store       in=\cubey,
    depth/.store        in=\cubez,
    scale/.store        in=\scale,
    xlabel/.store       in=\boxlabels,
    ylabel/.store       in=\ylabel,
    zlabel/.store       in=\zlabels,
    caption/.store      in=\caption,
    name/.store         in=\name,
    fill/.store         in=\fill,
    bandfill/.store     in=\bandfill,
    opacity/.store      in=\opacity,
    bandopacity/.store  in=\bandopacity,
    fill={rgb:red,5;green,5;blue,5;white,15},
    bandfill={rgb:red,5;green,5;blue,5;white,5},
    opacity=0.4,
    bandopacity=0.6,
    width=2,
    height=13,
    depth=15,
    scale=.2,
    xlabel={{"","","","","","","","","",""}},
    ylabel=,
    zlabel=,
    caption=,
    name=,
}

\def\ConvColor{rgb:yellow,5;red,2.5;white,5}
\def\ConvReluColor{rgb:yellow,5;red,5;white,5}
\def\PoolColor{rgb:red,1;black,0.3}
\def\UnpoolColor{rgb:blue,2;green,1;black,0.3}
\def\FcColor{rgb:blue,5;red,2.5;white,5}
\def\FcReluColor{rgb:blue,5;red,5;white,4}
\def\SoftmaxColor{rgb:blue,4;green,3;black,3}
\def\SumColor{rgb:blue,5;green,15}

\definecolor{backbonepink}{RGB}{255,182,193}
\definecolor{backboneblue}{RGB}{173,216,230}
\def\ConvColor{backbonepink}
\def\ConvReluColor{backboneblue}

\newcommand{\copymidarrow}{\tikz \draw[-Stealth,line width=0.8mm,draw={rgb:blue,4;red,1;green,1;black,3}] (-0.3,0) -- ++(0.3,0);}

\begin{document}
\begin{tikzpicture}[scale=0.85, transform shape]
\tikzstyle{connection}=[thick,every node/.style={sloped,allow upside down},draw=\edgecolor,opacity=0.7]
\tikzstyle{copyconnection}=[thick,every node/.style={sloped,allow upside down},draw={rgb:blue,4;red,1;green,1;black,3},opacity=0.7]

\node[canvas is zy plane at x=0] (input) at (-6,0,0) {\includegraphics[width=5cm,height=5cm]{diatom.png}};
\coordinate (input-east) at ($(input) + (2.5,0,0)$);

\useasboundingbox (-6,-20) rectangle (25,12);

\pic[shift={ (0,0,0) }] at (-4,0,0) 
    {RightBandedBox={
        name=backbone,
        caption=EfficientNet-B0\\Backbone,
        fill=\ConvColor,
        bandfill=\ConvReluColor,
        height=28,
        width=14,
        depth=28
        }
    };

\pic[shift={ (1.5,0,0) }] at (backbone-east) 
    {Box={
        name=gap,
        caption=GAP,
        fill=\PoolColor,
        opacity=0.5,
        height=7,
        width=2,
        depth=7
        }
    };

\pic[shift={(2.5,0,0)}] at (gap-east) 
    {Box={
        name=features,
        caption=Feature Vector\\(1280-dim),
        fill=\SoftmaxColor,
        opacity=0.8,
        height=8,
        width=4,
        depth=18
        }
    };

% Connections without arrows
\draw [connection]  (input-east) -- (backbone-west);
\draw [connection]  (backbone-east)  -- (gap-west);
\draw [connection]  (gap-east)      -- (features-west);

\pic[shift={(7,9,0)}] at (features-east) 
    {Box={
        name=class_fc,
        caption=Class~MLP\\1280$\rightarrow$512$\rightarrow$3,
        fill=\ConvColor,
        height=5,
        width=13,
        depth=5
        }
    };

\draw [connection, draw={rgb:red,10;green,6.47;blue,0}]  (features-east)    -- (class_fc-west);

\coordinate (prediction-ref) at ($(class_fc-east) + (10,0,0) + (3.5,0,0)$);

\pic[shift={(-3.5,0,0)}] at (prediction-ref) 
    {Box={
        name=class_out,
        caption=Class~Probabilities~(3),
        fill=\SoftmaxColor,
        opacity=0.8,
        height=3,
        width=3.5,
        depth=3
        }
    };

\draw [connection, draw={rgb:red,10;green,6.47;blue,0}]  (class_fc-east)    -- (class_out-west);

\pic[shift={(7,5.5,0)}] at (features-east) 
    {Box={
        name=order_fc,
        caption=Order~MLP\\1283$\rightarrow$512$\rightarrow$256$\rightarrow$2,
        fill=\ConvColor,
        height=5,
        width={9, 6.4},
        depth=5
        }
    };

\draw [connection, draw={rgb:red,0;green,4.82;blue,10}]  (features-east)    -- (order_fc-west);

\draw [connection, draw={rgb:red,10;green,6.47;blue,0}]  (class_out-east)    -- (order_fc-west);

\pic[shift={(-3.5,-3.5,0)}] at (prediction-ref) 
    {Box={
        name=order_out,
        caption=Order~Probabilities~(2),
        fill=\SoftmaxColor,
        opacity=0.8,
        height=3.5,
        width=3.5,
        depth=3.5
        }
    };

\draw [connection, draw={rgb:red,0;green,4.82;blue,10}]  (order_fc-east)    -- (order_out-west);

\pic[shift={(7,2,0)}] at (features-east) 
    {Box={
        name=family_fc,
        caption=Family~MLP\\1285$\rightarrow$512$\rightarrow$256$\rightarrow$3,
        fill=\ConvColor,
        height=5,
        width={9, 6.4},
        depth=5
        }
    };

\draw [connection, draw={rgb:red,10;green,0.78;blue,5.76}]  (features-east)    -- (family_fc-west);

\draw [connection, draw={rgb:red,10;green,6.47;blue,0}]  (class_out-east)    -- (family_fc-west);

\draw [connection, draw={rgb:red,0;green,4.82;blue,10}]  (order_out-east)    -- (family_fc-west);

\pic[shift={(-3.5,-7,0)}] at (prediction-ref) 
    {Box={
        name=family_out,
        caption=Family~Probabilities~(3),
        fill=\SoftmaxColor,
        opacity=0.8,
        height=3.5,
        width=3.5,
        depth=3.5
        }
    };

\draw [connection, draw={rgb:red,10;green,0.78;blue,5.76}]  (family_fc-east)    -- (family_out-west);

\pic[shift={(7,-3,0)}] at (features-east) 
    {Box={
        name=genus_fc,
        caption=Genus~MLP\\1288$\rightarrow$1024$\rightarrow$512$\rightarrow$256$\rightarrow$24,
        fill=\ConvColor,
        height=5.5,
        width={8.4, 6.4, 5},
        depth=5.5
        }
    };

\draw [connection, draw={rgb:red,5.65;green,9.33;blue,5.65}]  (features-east)    -- (genus_fc-west);

\draw [connection, draw={rgb:red,10;green,6.47;blue,0}]  (class_out-east)    -- (genus_fc-west);

\draw [connection, draw={rgb:red,0;green,4.82;blue,10}]  (order_out-east)    -- (genus_fc-west);

\draw [connection, draw={rgb:red,10;green,0.78;blue,5.76}]  (family_out-east)    -- (genus_fc-west);

\pic[shift={(-3.5,-12,0)}] at (prediction-ref) 
    {Box={
        name=genus_out,
        caption=Genus~Probabilities~(24),
        fill=\SoftmaxColor,
        opacity=0.8,
        height=3.5,
        width=3.5,
        depth=3.5
        }
    };

\draw [connection, draw={rgb:red,5.65;green,9.33;blue,5.65}]  (genus_fc-east)    -- (genus_out-west);

\pic[shift={(7,-7.5,0)}] at (features-east) 
    {Box={
        name=species_fc,
        caption=Species~MLP\\1312$\rightarrow$1024$\rightarrow$512$\rightarrow$256$\rightarrow$82,
        fill=\ConvColor,
        height=5.5,
        width={8.4, 6.4, 5},
        depth=5.5
        }
    };

\draw [connection, draw={rgb:red,5.41;green,1.69;blue,8.86}]  (features-east)    -- (species_fc-west);

\draw [connection, draw={rgb:red,10;green,6.47;blue,0}]  (class_out-east)    -- (species_fc-west);

\draw [connection, draw={rgb:red,0;green,4.82;blue,10}]  (order_out-east)    -- (species_fc-west);

\draw [connection, draw={rgb:red,10;green,0.78;blue,5.76}]  (family_out-east)    -- (species_fc-west);

\draw [connection, draw={rgb:red,5.65;green,9.33;blue,5.65}]  (genus_out-east)    -- (species_fc-west);

\pic[shift={(-3.5,-16.5,0)}] at (prediction-ref) 
    {Box={
        name=species_out,
        caption=Species~Probabilities~(82),
        fill=\SoftmaxColor,
        opacity=0.8,
        height=4,
        width=3.5,
        depth=4
        }
    };

\draw [connection, draw={rgb:red,5.41;green,1.69;blue,8.86}]  (species_fc-east)    -- (species_out-west);

\end{tikzpicture}
\end{document}
